<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Upload ·∫£nh Imgur ‚Äì T·ª± n√©n WebP</title>
  <style>
    body.loading .loading-modal { display: block; }
    .dropzone {
      border: 2px dashed #999;
      border-radius: 10px;
      position: relative;
      margin: 0 auto;
      clear: both;
    }
    .infoimg {
      margin: 0 auto;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .dropzone p {
      margin: 0;
      text-align: center;
      width: 100%;
      font-weight: bold;
      color: #999;
    }
    .input {
      height: 100%;
      left: 0;
      outline: 0;
      opacity: 0;
      position: absolute;
      top: 0;
      width: 100%;
      cursor: pointer;
    }
    .status {
      border-radius: 5px;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
      max-width: 500px;
      font-family: system-ui, sans-serif;
      font-size: 14px;
    }
    .image-url {
      width: calc(100% - 10px);
      padding: 5px;
      border: 1px solid #999;
      border-radius: 5px;
      color: #333;
    }
    .linkimg { margin: 20px 0; }
    .dropzone.dropzone-dragging { border-color: #000; }
    .loading-modal {
      background-color: rgba(255,255,255,.8);
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
    }
    .loading-table {
      margin-left: auto;
      margin-right: auto;
      margin-top: 15%;
      margin-bottom: 15%;
    }
    #copyAllLinksBtn {
      margin: 20px auto;
      display: none;
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="dropzone">
    <div class="infoimg"></div>
  </div>
  <div class="status"></div>
  <button id="copyAllLinksBtn">üìã Copy t·∫•t c·∫£ link ·∫£nh</button>

  <script>
    // ==================== Helper: Chuy·ªÉn File => WebP ====================
    async function compressToWebP(file, quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) reject(new Error('File kh√¥ng ph·∫£i ·∫£nh'));
        const reader = new FileReader();
        const img = new Image();
        reader.onload = e => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            canvas.toBlob(blob => {
              if (!blob) return reject(new Error('Kh√¥ng th·ªÉ chuy·ªÉn WebP'));
              // ƒê√≥ng g√≥i th√†nh File ƒë·ªÉ gi·ªØ name & type
              const webpFile = new File([blob], 'upload.webp', { type: 'image/webp' });
              resolve({ webpFile, newSize: blob.size });
            }, 'image/webp', quality);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ==================== Imgur Module (gi·ªØ nguy√™n core) ====================
    (function (root, factory) {
      if (typeof define === 'function' && define.amd) {
        define([], factory);
      } else if (typeof exports === 'object') {
        module.exports = factory();
      } else {
        root.Imgur = factory();
      }
    }(this, function () {
      var Imgur = function (options) {
        if (!this || !(this instanceof Imgur)) return new Imgur(options);
        if (!options) options = {};
        if (!options.clientid) throw 'Provide a valid Client Id here: https://api.imgur.com/';
        this.clientid = options.clientid;
        this.endpoint = 'https://api.imgur.com/3/image';
        this.callback = options.callback || undefined;
        this.dropzone = document.querySelectorAll('.dropzone');
        this.infoimg = document.querySelectorAll('.infoimg');
        this.run();
      };
      Imgur.prototype = {
        createEls: function (name, props, text) {
          var el = document.createElement(name), p;
          for (p in props) if (props.hasOwnProperty(p)) el[p] = props[p];
          if (text) el.appendChild(document.createTextNode(text));
          return el;
        },
        insertAfter: function (ref, node) { ref.parentNode.insertBefore(node, ref.nextSibling); },
        post: function (path, data, callback) {
          var xhttp = new XMLHttpRequest();
          xhttp.open('POST', path, true);
          xhttp.setRequestHeader('Authorization', 'Client-ID ' + this.clientid);
          xhttp.onreadystatechange = function () {
            if (this.readyState === 4) {
              if (this.status >= 200 && this.status < 300) {
                var response = '';
                try { response = JSON.parse(this.responseText); } catch (err) { response = this.responseText; }
                callback.call(window, response);
              } else {
                callback.call(window, { success: false, status: this.status, message: this.statusText });
              }
            }
          };
          xhttp.send(data);
          xhttp = null;
        },
        createDragZone: function () {
          const p1 = this.createEls('p', {}, 'K√©o ·∫£nh v√†o ƒë√¢y');
          const p2 = this.createEls('p', {}, 'Ho·∫∑c click ƒë·ªÉ ch·ªçn ·∫£nh');
          const input = this.createEls('input', { type: 'file', className: 'input', accept: 'image/*', multiple: true });
          this.infoimg.forEach(zone => { zone.appendChild(p1.cloneNode(true)); zone.appendChild(p2.cloneNode(true)); });
          this.dropzone.forEach(zone => { zone.appendChild(input.cloneNode(true)); this.status(zone); this.upload(zone); });
        },
        loading: function () {
          if (document.querySelector('.loading-modal')) return;
          const modal = this.createEls('div', { className: 'loading-modal' });
          const table = this.createEls('table', { className: 'loading-table' });
          const img = this.createEls('img', { src: 'https://firebasestorage.googleapis.com/v0/b/huydc-090288.appspot.com/o/Images%20Upload%2Floading-spin.svg?alt=media&token=8a1fd8dc-30b2-4b74-acc6-9e4ce55a89b0' });
          table.appendChild(img); modal.appendChild(table); document.body.appendChild(modal);
        },
        status: function (el) { this.insertAfter(el, this.createEls('div', { className: 'status' })); },
        // ------------------- Upload & n√©n WebP -------------------
        matchFiles: async function (file, zone) {
          const status = zone.nextSibling;
          if (!file.type.startsWith('image/')) {
            status.className = 'status bg-danger';
            status.innerText = 'File kh√¥ng ph·∫£i ·∫£nh!';
            return;
          }
          document.body.classList.add('loading');
          status.className = 'status';
          status.innerText = 'ƒêang n√©n...';
          try {
            const originalSize = file.size;
            const { webpFile, newSize } = await compressToWebP(file, 0.8);
            status.innerText = 'ƒêang upload...';
            const fd = new FormData();
            fd.append('image', webpFile);
            fd.append('type', 'file'); // th√¥ng b√°o ƒë√¢y l√† file binary
            this.post(this.endpoint, fd, (data) => {
              document.body.classList.remove('loading');
              if (typeof this.callback === 'function') this.callback.call(this, data);
              if (data.success) {
                status.className = 'status bg-success';
                status.innerHTML += `<br>Gi·∫£m t·ª´ ${(originalSize/1024).toFixed(1)} KB xu·ªëng ${(newSize/1024).toFixed(1)} KB`;
              } else {
                status.className = 'status bg-danger';
                status.innerText = 'L·ªói upload: ' + (data.message || 'Kh√¥ng r√µ');
              }
            });
          } catch (err) {
            document.body.classList.remove('loading');
            status.className = 'status bg-danger';
            status.innerText = err.message;
          }
        },
        upload: function (zone) {
          const events = ['dragenter', 'dragleave', 'dragover', 'drop'];
          zone.addEventListener('change', (e) => {
            if (e.target && e.target.type === 'file') {
              Array.from(e.target.files).forEach(file => this.matchFiles(file, zone));
            }
          });
          events.forEach(evt => {
            zone.addEventListener(evt, (e) => {
              if (e.target && e.target.type === 'file') {
                e.target.parentNode.classList.toggle('dropzone-dragging', evt !== 'dragleave' && evt !== 'drop');
              }
            });
          });
        },
        run: function () { this.loading(); this.createDragZone(); }
      };
      return Imgur;
    }));

    // ==================== Kh·ªüi t·∫°o ====================
    const allLinks = [];
    const copyBtn = document.getElementById('copyAllLinksBtn');
    function updateCopyButton() { copyBtn.style.display = allLinks.length ? 'block' : 'none'; }

    const feedback = (res) => {
      const statusDiv = document.querySelector('.status');
      if (res.success) {
        const link = res.data.link.replace(/^http:/, 'https:');
        allLinks.push(link);
        statusDiv.className = 'status bg-success';
        statusDiv.innerHTML += `\n<div class="linkimg"><input class="image-url" onclick="this.select()" value="${link}" /></div>` +
                               `<div class="showimg"><img style="max-width:100%;margin-bottom:10px;" src="${link}" /></div>`;
        updateCopyButton();
      } else {
        statusDiv.className = 'status bg-danger';
        statusDiv.innerText = 'Upload th·∫•t b·∫°i: ' + (res.message || 'Kh√¥ng r√µ l√Ω do');
      }
    };

    new Imgur({ clientid: '3a8be4390ef3eb8', callback: feedback });
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(allLinks.join('\n')).then(() => alert(`‚úÖ ƒê√£ copy ${allLinks.length} link!`));
    });
  </script>
</body>
</html>
