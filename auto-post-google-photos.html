<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tool xử lý ảnh SEO + Viết bài AI cho Blogger</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    img { max-width: 150px; border: 1px solid #ccc; margin: 5px; }
    .preview-wrapper { display: flex; flex-wrap: wrap; gap: 10px; }
    textarea, input[type=text] { width: 100%; box-sizing: border-box; }
    textarea { height: 150px; margin-top: 10px; }
    button { margin-top: 10px; margin-right: 10px; padding: 8px 15px; }
    #aiOutput { height: 300px; }
    .copy-button { background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .copy-button:hover { background-color: #45a049; }
    .copy-success { color: green; font-weight: bold; margin-left: 10px; }
    .output-section { position: relative; }
  </style>
</head>
<body>
  <h2>🛠️ Tool Xử Lý Ảnh SEO + Watermark + Viết Bài AI cho Blogger</h2>

  <section>
    <h3>1. Xử lý ảnh</h3>
    <p>📤 <strong>Chọn ảnh:</strong></p>
    <input type="file" id="imageInput" accept="image/*" multiple /><br /><br />

    <p>🔑 <strong>Từ khóa SEO:</strong></p>
    <input type="text" id="keywordInput" placeholder="Ví dụ: Quỳnh Alee bikini" /><br /><br />

    <p>🖼️ <strong>Định dạng ảnh:</strong></p>
    <select id="formatSelect">
      <option value="jpeg">JPEG</option>
      <option value="webp">WebP</option>
    </select><br /><br />

    <p>🔖 <strong>Chọn watermark (PNG):</strong></p>
    <input type="file" id="watermarkInput" accept="image/png" /><br /><br />

    <button onclick="processImages()">🔥 Xử lý ảnh & Tải về</button>
    <button onclick="generateHtml()">📋 Sinh HTML chèn Blogger</button><br /><br />

    <div class="preview-wrapper" id="preview"></div>

    <div class="output-section">
      <h3>📄 Mã HTML để dán vào bài Blogger:</h3>
      <button class="copy-button" onclick="copyHtml()">📋 Copy HTML</button>
      <span id="htmlCopyStatus" class="copy-success"></span>
      <textarea id="htmlOutput" readonly></textarea>
    </div>
  </section>

  <hr />

  <section>
    <h3>2. Viết bài tự động bằng AI</h3>
    <p>📝 <strong>Nhập chủ đề hoặc tiêu đề bài viết:</strong></p>
    <input type="text" id="aiTopicInput" placeholder="Ví dụ: Du lịch Đà Nẵng nên đi đâu?" /><br />
    <button onclick="generateAIArticle()">🤖 Tạo bài viết tự động</button><br />
    <p id="aiStatus" style="color: green; font-weight: bold;"></p>
    
    <div class="output-section">
      <button class="copy-button" onclick="copyAIContent()">📋 Copy bài viết</button>
      <span id="aiCopyStatus" class="copy-success"></span>
      <textarea id="aiOutput" placeholder="Nội dung bài viết tự động sẽ hiện ở đây..."></textarea>
    </div>
  </section>

  <script>
    // Hàm chuyển chuỗi tiếng Việt có dấu sang không dấu, và thay khoảng trắng thành dấu '-'
    function removeVietnamese(str) {
      str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      str = str.replace(/đ/g, "d").replace(/Đ/g, "D");
      str = str.replace(/[^a-zA-Z0-9\s]/g, "");
      return str.trim().replace(/\s+/g, "-").toLowerCase();
    }

    // Xử lý ảnh giống như bản trước
    function processImages() {
      const images = document.getElementById("imageInput").files;
      const keyword = document.getElementById("keywordInput").value.trim();
      const format = document.getElementById("formatSelect").value;
      const watermarkFile = document.getElementById("watermarkInput").files[0];

      if (!images.length || !keyword) {
        alert("Vui lòng chọn ảnh và nhập từ khóa.");
        return;
      }

      const cleanName = removeVietnamese(keyword);
      const preview = document.getElementById("preview");
      preview.innerHTML = "";

      Array.from(images).forEach((image, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const maxWidth = 1200;
            let scale = 1;
            if (img.width > maxWidth) {
              scale = maxWidth / img.width;
            }
            const canvas = document.createElement("canvas");
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            if (watermarkFile) {
              const wmReader = new FileReader();
              wmReader.onload = function(ev) {
                const wmImg = new Image();
                wmImg.onload = function() {
                  const wmScale = 0.2 * scale;
                  const wmWidth = wmImg.width * wmScale;
                  const wmHeight = wmImg.height * wmScale;
                  ctx.drawImage(wmImg, canvas.width - wmWidth - 10, canvas.height - wmHeight - 10, wmWidth, wmHeight);
                  exportImage(canvas, cleanName, index, format, preview);
                };
                wmImg.src = ev.target.result;
              };
              wmReader.readAsDataURL(watermarkFile);
            } else {
              exportImage(canvas, cleanName, index, format, preview);
            }
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(image);
      });
    }

    function exportImage(canvas, baseName, index, format, preview) {
      if (!canvas.toBlob) {
        alert("Trình duyệt của bạn không hỗ trợ tính năng này.");
        return;
      }
      canvas.toBlob(function(blob) {
        const fileName = `${baseName}-${index + 1}.${format}`;
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();

        const imgTag = document.createElement("img");
        imgTag.src = url;
        imgTag.title = fileName;
        imgTag.alt = fileName;
        preview.appendChild(imgTag);

        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 300000);
      }, `image/${format}`, 0.9);
    }

    function generateHtml() {
      const imgs = document.querySelectorAll("#preview img");
      let html = "";
      imgs.forEach(img => {
        html += `<img src="${img.src}" alt="${img.alt}" title="${img.title}" style="max-width:100%;" /><br>\n`;
      });
      document.getElementById("htmlOutput").value = html;
    }

    // Hàm copy HTML
    function copyHtml() {
      const htmlOutput = document.getElementById("htmlOutput");
      const htmlCopyStatus = document.getElementById("htmlCopyStatus");
      
      if (htmlOutput.value.trim() === "") {
        alert("Chưa có mã HTML để copy. Vui lòng xử lý ảnh trước.");
        return;
      }
      
      htmlOutput.select();
      htmlOutput.setSelectionRange(0, 99999); // Cho mobile
      
      try {
        document.execCommand('copy');
        htmlCopyStatus.textContent = "✅ Đã copy!";
        setTimeout(() => {
          htmlCopyStatus.textContent = "";
        }, 2000);
      } catch (err) {
        // Fallback cho trình duyệt hiện đại
        navigator.clipboard.writeText(htmlOutput.value).then(() => {
          htmlCopyStatus.textContent = "✅ Đã copy!";
          setTimeout(() => {
            htmlCopyStatus.textContent = "";
          }, 2000);
        }).catch(() => {
          alert("Không thể copy. Vui lòng copy thủ công.");
        });
      }
    }

    // Hàm copy nội dung AI
    function copyAIContent() {
      const aiOutput = document.getElementById("aiOutput");
      const aiCopyStatus = document.getElementById("aiCopyStatus");
      
      if (aiOutput.value.trim() === "") {
        alert("Chưa có nội dung bài viết để copy. Vui lòng tạo bài viết trước.");
        return;
      }
      
      aiOutput.select();
      aiOutput.setSelectionRange(0, 99999); // Cho mobile
      
      try {
        document.execCommand('copy');
        aiCopyStatus.textContent = "✅ Đã copy!";
        setTimeout(() => {
          aiCopyStatus.textContent = "";
        }, 2000);
      } catch (err) {
        // Fallback cho trình duyệt hiện đại
        navigator.clipboard.writeText(aiOutput.value).then(() => {
          aiCopyStatus.textContent = "✅ Đã copy!";
          setTimeout(() => {
            aiCopyStatus.textContent = "";
          }, 2000);
        }).catch(() => {
          alert("Không thể copy. Vui lòng copy thủ công.");
        });
      }
    }

    // --- Phần AI viết bài tự động ---
    async function generateAIArticle() {
      const topic = document.getElementById("aiTopicInput").value.trim();
      const aiStatus = document.getElementById("aiStatus");
      const aiOutput = document.getElementById("aiOutput");

      if (!topic) {
        alert("Vui lòng nhập chủ đề bài viết.");
        return;
      }

      aiStatus.textContent = "Đang tạo bài viết... vui lòng chờ trong giây lát.";
      aiOutput.value = "";

      // Thay YOUR_OPENAI_API_KEY bằng API key thật của bạn
      const apiKey = "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";

      const prompt = `Viết một bài viết chi tiết chuẩn SEO bằng tiếng Việt về chủ đề: "${topic}". Bài viết nên dài khoảng 300-500 từ, có đoạn mở đầu hấp dẫn, các đoạn thân bài rõ ràng, kết luận súc tích.`;

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }],
            temperature: 0.7,
            max_tokens: 700,
          })
        });

        if (!response.ok) {
          throw new Error(`Lỗi API: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const text = data.choices && data.choices[0] && data.choices[0].message.content;
        if (text) {
          aiOutput.value = text.trim();
          aiStatus.textContent = "Tạo bài viết thành công!";
        } else {
          aiOutput.value = "";
          aiStatus.textContent = "Không nhận được nội dung trả về.";
        }

      } catch (error) {
        aiStatus.textContent = "Có lỗi xảy ra: " + error.message;
        aiOutput.value = "";
      }
    }
  </script>
</body>
</html>
