<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Tool Upload ·∫¢nh & Thay Link Blogger</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    textarea { width: 100%; font-family: monospace; margin-top: 10px; }
    input[type="file"] { margin-top: 10px; }
    button { padding: 10px 20px; margin-top: 20px; font-size: 16px; }
    h2 { margin-top: 30px; }
  </style>
</head>
<body>

<h1>üöÄ Tool Upload ·∫¢nh & T·ª± ƒê·ªông Thay Link Trong HTML (Blogger)</h1>

<h2>1Ô∏è‚É£ D√°n ƒëo·∫°n HTML b√†i vi·∫øt ch·ª©a ·∫£nh c≈©</h2>
<textarea id="htmlInput" rows="10" placeholder="D√°n ƒëo·∫°n HTML t·ª´ b√†i vi·∫øt Blogger v√†o ƒë√¢y..."></textarea>

<h2>2Ô∏è‚É£ Ch·ªçn ·∫£nh m·ªõi t·ª´ m√°y t√≠nh (√≠t nh·∫•t 1 ·∫£nh)</h2>
<input type="file" id="fileInput" multiple accept="image/*" />

<br /><br />
<button onclick="uploadAndReplace()">‚¨ÜÔ∏è Upload & üîÅ Thay Link ·∫¢nh</button>

<h2>‚úÖ K·∫øt qu·∫£ HTML m·ªõi (ƒë√£ thay link)</h2>
<textarea id="htmlOutput" rows="10" readonly></textarea>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwDZuYvVmHqQrF45XE-QqmCZClgChjcBRDuTUZkCOFE7W1KjB1tHIgRz4Q5VyDkuNdL/exec';

  async function uploadFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64Data = e.target.result.split(',')[1];
        try {
          const resp = await fetch(GAS_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
              file: base64Data,
              fileName: file.name,
              mimeType: file.type
            })
          });
          const data = await resp.json();
          if(data.url) {
            resolve(data.url);
          } else {
            reject(data.error || 'L·ªói upload');
          }
        } catch(err) {
          reject(err);
        }
      };
      reader.readAsDataURL(file);
    });
  }

  async function uploadAndReplace() {
    const html = document.getElementById('htmlInput').value;
    const files = document.getElementById('fileInput').files;

    if (!html) {
      alert('‚ö†Ô∏è Vui l√≤ng d√°n ƒëo·∫°n HTML b√†i vi·∫øt tr∆∞·ªõc.');
      return;
    }
    if (files.length === 0) {
      alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ·∫£nh.');
      return;
    }

    const regex = /https:\/\/blogger\.googleusercontent\.com\/img\/a\/[^\s"'<>]+/g;
    const oldUrls = html.match(regex);

    if (!oldUrls || oldUrls.length === 0) {
      alert('‚ùå Kh√¥ng t√¨m th·∫•y ·∫£nh c≈© trong ƒëo·∫°n HTML.');
      return;
    }

    // T·∫°o m·∫£ng file, n·∫øu thi·∫øu th√¨ l·∫∑p l·∫°i ·∫£nh ƒë·∫ßu
    const fileArray = Array.from(files);
    while (fileArray.length < oldUrls.length) {
      fileArray.push(files[0]);
    }

    let newHtml = html;

    for (let i = 0; i < oldUrls.length; i++) {
      try {
        const newUrl = await uploadFile(fileArray[i]);
        newHtml = newHtml.replace(oldUrls[i], newUrl);
      } catch (e) {
        alert('‚ùå L·ªói upload ·∫£nh: ' + e);
        return;
      }
    }

    document.getElementById('htmlOutput').value = newHtml;
    alert('‚úÖ Ho√†n t·∫•t! ƒê√£ thay t·∫•t c·∫£ link ·∫£nh.');
  }
</script>

</body>
</html>
